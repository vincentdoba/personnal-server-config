---
- name: Add remote user as sudoer for gitlab
  lineinfile: dest=/etc/sudoers state=present line="{{ansible_ssh_user}} ALL=(ALL:ALL) ALL"

- name: Reload sudo configuration after adding remote user for gitlab
  service: name=sudo state=restarted

- name: Create gitlab database user
  become: yes
  become_method: sudo
  become_user: postgres
  postgresql_user: name={{gitlab_database_user}} password={{gitlab_database_user_password}} role_attr_flags=NOSUPERUSER,CREATEDB state=present

- name: Create gitlab database
  become: yes
  become_method: sudo
  become_user: postgres
  postgresql_db: name={{gitlab_database_name}} owner={{gitlab_database_user}} state=present 

- name: Remove remote user as sudoer for gitlab
  lineinfile: dest=/etc/sudoers state=absent line="{{ansible_ssh_user}} ALL=(ALL:ALL) ALL"

- name: Reload sudo configuration after removing remote user for gitlab
  service: name=sudo state=restarted
