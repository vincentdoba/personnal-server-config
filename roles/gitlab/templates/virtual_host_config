server {
  listen 80;
  server_tokens off;
  server_name {{gitlab_hostname}};
  rewrite ^ https://$server_name$request_uri permanent;
}

server {
  listen 443;
  server_tokens off;
  server_name {{gitlab_hostname}};
  root {{gitlab_root_directory}};

  ssl on;
  ssl_certificate ssl/gitlab_server.crt;
  ssl_certificate_key ssl/gitlab_server.key;

  client_max_body_size 250m;

  access_log  /var/log/gitlab/nginx/gitlab_access.log;
  error_log   /var/log/gitlab/nginx/gitlab_error.log;

  # Ensure Passenger uses the bundled Ruby version
  passenger_ruby /opt/gitlab/embedded/bin/ruby;

  # Correct the $PATH variable to included packaged executables
  passenger_env_var PATH "/opt/gitlab/bin:/opt/gitlab/embedded/bin:/usr/local/bin:/usr/bin:/bin";

  # Make sure Passenger runs as the correct user and group to
  # prevent permission issues
  passenger_user git;
  passenger_group git;

  # Enable Passenger & keep at least one instance running at all times
  passenger_enabled on;
  passenger_min_instances 1;

  error_page 502 /502.html;

}
