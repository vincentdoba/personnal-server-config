---
- name: Install all roundcube necessary packages
  apt: pkg={{ item }} state=present
  with_items:
    - php5
    - php-pear
    - php5-sqlite
    - php5-mcrypt
    - php5-intl 
  become: yes
  become_method: su

- name: Create rouncube directory
  file: path=/home/sites/roundcube state=directory recurse=yes owner=www-data group=www-data mode=0755
  become: yes
  become_method: su

# TODO change it with generation of site
- name: Copy temporary roundcube index file
  copy: dest=/home/sites/roundcube/index.html src=index.html owner=www-data group=www-data mode=0644
  become: yes
  become_method: su

- name: Setup roundcube certificates
  command: openssl req -new -nodes -x509 -subj "/C=FR/ST=Paris/L=Paris/O=IT/CN={{ roundcube_hostname }}" -days 3650 -keyout /etc/nginx/ssl/roundcube_server.key -out /etc/nginx/ssl/roundcube_server.crt -extensions v3_ca creates=/etc/nginx/ssl/roundcube_server.crt
  become: yes
  become_method: su
  notify: Reload nginx

- name: Create roundcube virtual host
  template: src=virtual_host_config dest=/etc/nginx/sites-available/roundcube
  notify: Reload nginx
  become: yes
  become_method: su
 
- name: Create roundcube link in site-enabled
  file: src=/etc/nginx/sites-available/roundcube state=link dest=/etc/nginx/sites-enabled/roundcube
  notify: Reload nginx 
  become: yes
  become_method: su

- name: Create line for roundcube in /etc/hosts
  lineinfile: dest=/etc/hosts line="127.0.0.1 {{ roundcube_hostname }}" insertafter="^127"
  become: yes
  become_method: su
